<!DOCTYPE html>
<html class="writer-html5" lang="ja" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>16. SES &mdash; project  ドキュメント</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
        <script src="../_static/translations.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="検索" href="../search.html" />
    <link rel="next" title="1. GCPについて" href="../GCP/GCP.html" />
    <link rel="prev" title="15. AutoScaling" href="AutoScaling.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> project
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">AWS:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="AWS.html">1. AWSについて</a></li>
<li class="toctree-l1"><a class="reference internal" href="../IAM.html">2. IAM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Network.html">3. Network</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Front.html">4. Front</a></li>
<li class="toctree-l1"><a class="reference internal" href="../EC2.html">5. EC2</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Container.html">6. コンテナ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../S3.html">7. S3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CloudFormation.html">8. CloudFormation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CloudWatch.html">9. CloudWatch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Storage.html">10. Storage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../DB.html">11. DB</a></li>
<li class="toctree-l1"><a class="reference internal" href="../SystemsManager.html">12. SystemsManager</a></li>
<li class="toctree-l1"><a class="reference internal" href="CloudTrail.html">13. CloudTrail</a></li>
<li class="toctree-l1"><a class="reference internal" href="EventBridge.html">14. EventBridge</a></li>
<li class="toctree-l1"><a class="reference internal" href="AutoScaling.html">15. AutoScaling</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">16. SES</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#id1">16.1. SESのメール受信</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id2">16.1.1. 受信ルール</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id3">16.1.2. 受信制約</a></li>
<li class="toctree-l3"><a class="reference internal" href="#dns">16.1.3. 受信用DNS設定</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#txt">16.1.3.1. 利用ドメインの検証（TXTレコード）</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mx">16.1.3.2. 受信メール設定（MXレコード）</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id4">16.2. SESのメール送信</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id5">16.2.1. アクセスレベル</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id6">16.2.2. メール送信の制限</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id7">16.2.3. SESのモニタリング</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id8">16.2.4. バウンス</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id9">16.2.5. 送信用DNS設定</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id10">16.2.5.1. メール送信の信頼性担保</a></li>
<li class="toctree-l4"><a class="reference internal" href="#from">16.2.5.2. カスタム メール FROM</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id11">16.3. 送受信制約</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id12">16.3.1. メールサイズ</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id13">16.3.2. 添付ファイル</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#sesdns">16.4. SESで設定するDNS設定のまとめ</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id14">16.5. SESの送受信実装例</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id15">16.5.1. ドメイン検証サンドボックスの解消</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id16">16.5.2. 受信実装</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#receipt-rule">16.5.2.1. 受信ルール(Receipt Rule)の設定</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id17">16.5.2.2. 受信元の制限</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id18">16.5.2.3. 受信に関する権限設定</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id19">16.5.3. 送信実装</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#api">16.5.3.1. 送信APIの利用</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id20">16.5.3.2. 送信に関する権限設定</a></li>
<li class="toctree-l4"><a class="reference internal" href="#sns">16.5.3.3. バウンス設定(SNS配信)</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">GCP:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../GCP/GCP.html">1. GCPについて</a></li>
<li class="toctree-l1"><a class="reference internal" href="../GCP/IAM.html">2. IAM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../GCP/API.html">3. Google Cloud APIs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../GCP/Network.html">4. Network</a></li>
<li class="toctree-l1"><a class="reference internal" href="../GCP/CICD.html">5. CICD</a></li>
<li class="toctree-l1"><a class="reference internal" href="../GCP/Front.html">6. Load Balancing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../GCP/GCE.html">7. GCE(Google Compute Engine)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../GCP/Container.html">8. コンテナサービス</a></li>
<li class="toctree-l1"><a class="reference internal" href="../GCP/Serverless.html">9. サーバーレスアーキテクチャ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../GCP/GKE.html">10. GKE</a></li>
<li class="toctree-l1"><a class="reference internal" href="../GCP/APIGW.html">11. API Gateway</a></li>
<li class="toctree-l1"><a class="reference internal" href="../GCP/Storage.html">12. ストレージ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../GCP/CloudOps.html">13. CloudOps</a></li>
<li class="toctree-l1"><a class="reference internal" href="../GCP/DB.html">14. DB</a></li>
<li class="toctree-l1"><a class="reference internal" href="../GCP/Workflows.html">15. Workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../GCP/CloudScheduler.html">16. Cloud Scheduler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../GCP/Pub-Sub.html">17. Pub/Sub</a></li>
<li class="toctree-l1"><a class="reference internal" href="../GCP/DataAnalytics.html">18. データ分析サービス</a></li>
<li class="toctree-l1"><a class="reference internal" href="../GCP/AI.html">19. AIサービス</a></li>
<li class="toctree-l1"><a class="reference internal" href="../GCP/Redis.html">20. MemoryStore</a></li>
<li class="toctree-l1"><a class="reference internal" href="../GCP/misc.html">21. その他</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ITBasic:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../ITBasic/%E9%96%8B%E7%99%BA%E5%B7%A5%E7%A8%8B.html">1. V字モデル</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ITBasic/Agile.html">2. Agile</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ITBasic/SRE.html">3. SRE</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ITBasic/Network.html">4. Network</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ITBasic/SWA.html">5. SoftWareArchitecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ITBasic/SWA.html#id4">6. マイクロサービスアーキテクチャ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ITBasic/server.html">7. サーバー</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ITBasic/kernel.html">8. カーネル</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ITBasic/Container.html">9. コンテナ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ITBasic/Terraform.html">10. Terraform</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ITBasic/Kubernetes.html">11. Kubernetes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ITBasic/Kubernetes.html#istio">12. Istio</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ITBasic/ServiceMesh.html">13. ServiceMesh</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ITBasic/NFS.html">14. NFS(Network File System)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ITBasic/SaaS.html">15. SaaS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ITBasic/CICD.html">16. CICD</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ITBasic/%E9%9D%9E%E6%A9%9F%E8%83%BD.html">17. 非機能</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Git:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Git/basic.html">1. gitの基本知識</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Git/branch_strategy.html">2. ブランチ戦略</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Git/starter.html">3. gitへの登録</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Security:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Security/cors.html">1. CORS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Security/SSL.html">2. セキュアな通信</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ProgramingCode:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../ProgramingCode/Excel.html">1. エクセル</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ProgramingCode/shell.html">2. Shell</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Book:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Book/TryHackMe.html">1. 7日間でハッキングを始める本まとめ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Book/%E3%82%BD%E3%83%95%E3%83%88%E3%82%A6%E3%82%A7%E3%82%A2%E9%96%8B%E7%99%BA%E3%81%AE%E5%A4%B1%E6%95%9742.html">2. ソフトウェア開発現場の「失敗」集めてみた</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ドキュメント管理:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Sphinx/sphinx.html">1. Sphinxとは</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Sphinx/sphinx.html#note">2. note</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Sphinx/sphinx.html#id1">3. Sphinxの初期設定</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Sphinx/sphinx.html#id9">4. Sphinxの基本的な利用方法</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Reveal/reveal.html">1. Reveal.jsとは</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Reveal/reveal.html#note">2. note</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Reveal/reveal.html#id1">3. Reveal.jsの初期設定</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Reveal/reveal.html#id6">4. Reveal.jsの基本的な利用方法</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">project</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a></li>
      <li class="breadcrumb-item active"><span class="section-number">16. </span>SES</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/AWS/SES.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="ses">
<h1><span class="section-number">16. </span>SES<a class="headerlink" href="#ses" title="この見出しへのパーマリンク">¶</a></h1>
<p>SES(Simple Email Service)は、コスト効率の高いメールサービス。
取得済みドメインについて、認証を行うことで取得済みドメインのメールについて送信および受信機能が可能。</p>
<section id="id1">
<h2><span class="section-number">16.1. </span>SESのメール受信<a class="headerlink" href="#id1" title="この見出しへのパーマリンク">¶</a></h2>
<p>所有しているドメインに対するメールについて、受信を行うメールサーバーとして利用が可能。
注意点として、一般的なメールボックスが用意されているわけではなく、S3への配信やLambdaによる処理を行う。</p>
<p><img alt="" src="../_images/SES_Receive_Processing.png" />
<a class="reference external" href="https://pages.awscloud.com/rs/112-TZM-766/images/20190521_AWS-BlackBelt_AmazonSES.pdf">AWS Black Belt Online Seminar SES</a></p>
<section id="id2">
<h3><span class="section-number">16.1.1. </span>受信ルール<a class="headerlink" href="#id2" title="この見出しへのパーマリンク">¶</a></h3>
<p>SESでは、受信したメールについての条件設定や特定の処理設定を行うことができる。
受信ルールは受信ルールセットとしてまとめられる。</p>
<p>具体的には、以下のような設定が可能</p>
<ul class="simple">
<li><p>送信元アドレスの条件設定</p></li>
<li><p>メールヘッダの内容</p></li>
</ul>
<p>これらの条件に応じて、S3への配信やLambdaでの後続処理の実行などの設定が行われる。</p>
</section>
<section id="id3">
<h3><span class="section-number">16.1.2. </span>受信制約<a class="headerlink" href="#id3" title="この見出しへのパーマリンク">¶</a></h3>
<p>SESには受信ルールとは別にIPアドレスフィルター機能が存在し、特定のIPからのメール受信を拒否することができる。</p>
<p><img alt="" src="../_images/SES_IP_Filter.png" />
<a class="reference external" href="https://pages.awscloud.com/rs/112-TZM-766/images/20190521_AWS-BlackBelt_AmazonSES.pdf">AWS Black Belt Online Seminar SES</a></p>
</section>
<section id="dns">
<h3><span class="section-number">16.1.3. </span>受信用DNS設定<a class="headerlink" href="#dns" title="この見出しへのパーマリンク">¶</a></h3>
<section id="txt">
<h4><span class="section-number">16.1.3.1. </span>利用ドメインの検証（TXTレコード）<a class="headerlink" href="#txt" title="この見出しへのパーマリンク">¶</a></h4>
<p>独自のドメインを経由してメールの受信を行う場合、利用するドメインの所有者であることをSESに認識させる必要がある。
SESのコンソール上で利用するドメインを登録すると、登録するべきランダムな値が提示されるので、ドメイン側のTXTレコードとして、その値を設定する。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>ホスト名（Name）: _amazonses.example.com
種類（Type）: TXT
値（Value）: SESが指定したランダムな文字列（例: `abcdef1234567890xyz=`）
TTL: 3600（またはデフォルト）
</pre></div>
</div>
<p>上記を設定して数時間でSESのコンソール側でドメインが認証されるので、認証後はTXTレコードを削除して良い。</p>
</section>
<section id="mx">
<h4><span class="section-number">16.1.3.2. </span>受信メール設定（MXレコード）<a class="headerlink" href="#mx" title="この見出しへのパーマリンク">¶</a></h4>
<p>ドメイン宛のメールをSESに転送するため、MXレコードをDNS側に設定する。
値については、リージョンごとに固定となっている。この設定から分かる通り、ドメインレベルでSESへの転送を行う。
仕組みとしては、<code class="docutils literal notranslate"><span class="pre">&#64;example.com</span></code>宛のメールについてはSESへの転送を行い、検証を行なっているSESへの配信を行う。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>ホスト名（Name）: example.com
種類（Type）: MX
値（Value）: 10 inbound-smtp.us-east-1.amazonaws.com
TTL: 3600
</pre></div>
</div>
</section>
</section>
</section>
<section id="id4">
<h2><span class="section-number">16.2. </span>SESのメール送信<a class="headerlink" href="#id4" title="この見出しへのパーマリンク">¶</a></h2>
<p>SESを利用したメール送信方法には大きく3つの種類が存在。</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head text-left"><p>インターフェース</p></th>
<th class="head text-left"><p>概要</p></th>
<th class="head text-left"><p>特徴</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-left"><p>SESコンソール</p></td>
<td class="text-left"><p>AWSマネジメントコンソールで直接メール送信をテストできる</p></td>
<td class="text-left"><p>GUIで簡単に操作可能。設定の確認やテスト送信に便利</p></td>
</tr>
<tr class="row-odd"><td class="text-left"><p>SES API</p></td>
<td class="text-left"><p>アプリケーションから直接メールを送信するためのAPIを提供</p></td>
<td class="text-left"><p>IAMで送信権限を設定する必要がある</p></td>
</tr>
<tr class="row-even"><td class="text-left"><p>｜---SendEmail API</p></td>
<td class="text-left"><p>From、To、Subject、Body を指定してメールを送信</p></td>
<td class="text-left"><p>シンプルなテキストメールやHTMLメールの送信が可能</p></td>
</tr>
<tr class="row-odd"><td class="text-left"><p>｜---SendRawEmail API</p></td>
<td class="text-left"><p>メッセージ全体をアプリケーションで生成し、カスタムヘッダーや添付ファイルを含めて送信</p></td>
<td class="text-left"><p>より高度なメール構成が可能</p></td>
</tr>
<tr class="row-even"><td class="text-left"><p>SMTP インターフェース</p></td>
<td class="text-left"><p>SESが準備しているSMTPエンドポイントが経由でメールを送信</p></td>
<td class="text-left"><p>認証情報（SMTPクレデンシャル）が必要</p></td>
</tr>
</tbody>
</table>
<section id="id5">
<h3><span class="section-number">16.2.1. </span>アクセスレベル<a class="headerlink" href="#id5" title="この見出しへのパーマリンク">¶</a></h3>
<p>SESにはアクセスレベルが設定されており、アカウントの初期状態の「サンドボックス」と「プロダクション」状態がある。
AWSアカウントでSESを初めて利用する場合、不正利用を防ぐためSES機能は初期状態でサンドボックス状態となっている。
サンドボックス状態ではメール送信の宛先に制約がある他、メールの送信のスロットリングに制約が設けられる。</p>
<p>サンドボックスで要件を満たすことができない場合は、AWSサポート経由で上限緩和申請を行いプロダクションへ変更する必要がある。</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head text-left"><p>制約項目</p></th>
<th class="head text-left"><p>サンドボックス (初期状態)</p></th>
<th class="head text-left"><p>上限緩和後 (プロダクション)</p></th>
<th class="head text-left"><p>備考</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-left"><p>送信対象</p></td>
<td class="text-left"><p>検証済みメールアドレス/ドメインのみ</p></td>
<td class="text-left"><p>制限なし (任意の宛先に送信可能)</p></td>
<td class="text-left"><p>初期状態ではテスト用途に限定される</p></td>
</tr>
<tr class="row-odd"><td class="text-left"><p>24時間あたりの送信可能メール数 (Sending Quota)</p></td>
<td class="text-left"><p>200通</p></td>
<td class="text-left"><p>AWSサポート申請で引き上げ可能</p></td>
<td class="text-left"><p>引き上げ後の上限はリージョンや使用状況による</p></td>
</tr>
<tr class="row-even"><td class="text-left"><p>1秒あたりの送信可能メール数 (Sending Rate)</p></td>
<td class="text-left"><p>1通/秒</p></td>
<td class="text-left"><p>AWSサポート申請で引き上げ可能</p></td>
<td class="text-left"><p>高速な大量送信が必要な場合は申請が必要</p></td>
</tr>
<tr class="row-odd"><td class="text-left"><p>バウンス・苦情率</p></td>
<td class="text-left"><p>厳しく制限</p></td>
<td class="text-left"><p>過剰なバウンス・苦情があると制限</p></td>
<td class="text-left"><p>SESの信頼性維持のため、適切なリスト管理が必要</p></td>
</tr>
<tr class="row-even"><td class="text-left"><p>承認プロセス</p></td>
<td class="text-left"><p>なし (デフォルト)</p></td>
<td class="text-left"><p>上限緩和申請が必要</p></td>
<td class="text-left"><p>AWS サポートに申請して解除</p></td>
</tr>
</tbody>
</table>
</section>
<section id="id6">
<h3><span class="section-number">16.2.2. </span>メール送信の制限<a class="headerlink" href="#id6" title="この見出しへのパーマリンク">¶</a></h3>
<p>SESでは、送受信制限が設定されている。
これは、SES自体がスパム判定されてしまうと、配信先のメールプロバイダーとの信頼関係が崩れてしまうためである。
具体的には、24時間帯の送信可能メールや1秒あたりの送信可能メール数に制約が設けられている</p>
</section>
<section id="id7">
<h3><span class="section-number">16.2.3. </span>SESのモニタリング<a class="headerlink" href="#id7" title="この見出しへのパーマリンク">¶</a></h3>
<p>送信制限の監視するため、SESではメールに対して以下のようなメトリクスを取得し監視することができる。</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head text-left"><p>メトリクス名</p></th>
<th class="head text-left"><p>説明</p></th>
<th class="head text-left"><p>活用用途</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-left"><p>Send (送信数)</p></td>
<td class="text-left"><p>SESが送信リクエストを受け付けたメールの数</p></td>
<td class="text-left"><p>送信ボリュームの監視</p></td>
</tr>
<tr class="row-odd"><td class="text-left"><p>Reject (拒否数)</p></td>
<td class="text-left"><p>SESがポリシー違反やブラックリスト登録などの理由で送信を拒否した数</p></td>
<td class="text-left"><p>不正な送信リクエストの監視、送信ポリシーの調整</p></td>
</tr>
<tr class="row-even"><td class="text-left"><p>Bounce (バウンス数)</p></td>
<td class="text-left"><p>送信したメールが受信者のメールサーバーに拒否された数</p></td>
<td class="text-left"><p>配信リストのクリーンアップ、信頼性向上</p></td>
</tr>
<tr class="row-odd"><td class="text-left"><p>Complaint (苦情数)</p></td>
<td class="text-left"><p>受信者が迷惑メール報告を行った数</p></td>
<td class="text-left"><p>メール品質の改善、リスト管理</p></td>
</tr>
<tr class="row-even"><td class="text-left"><p>Delivery (配信数)</p></td>
<td class="text-left"><p>正常に受信者に配信されたメールの数</p></td>
<td class="text-left"><p>送信成功率の分析</p></td>
</tr>
<tr class="row-odd"><td class="text-left"><p>Open (開封数) (new)</p></td>
<td class="text-left"><p>受信者がメールを開封した回数</p></td>
<td class="text-left"><p>メールのエンゲージメント測定</p></td>
</tr>
<tr class="row-even"><td class="text-left"><p>Click (クリック数) (new)</p></td>
<td class="text-left"><p>メール内のリンクがクリックされた回数</p></td>
<td class="text-left"><p>コンテンツの有効性分析</p></td>
</tr>
<tr class="row-odd"><td class="text-left"><p>Rendering Failure (レンダリング失敗数) (new)</p></td>
<td class="text-left"><p>テンプレートのエラーなどによりメールが正常に生成されなかった回数</p></td>
<td class="text-left"><p>メールテンプレートの検証、エラー防止</p></td>
</tr>
</tbody>
</table>
</section>
<section id="id8">
<h3><span class="section-number">16.2.4. </span>バウンス<a class="headerlink" href="#id8" title="この見出しへのパーマリンク">¶</a></h3>
<p>送信した際に、アドレスが存在しなかったり、受信拒否されている場合そのアドレスはハードバウンスとして扱われる。
ハードバウンスしたアドレスはSESで自動的にSuppression List(抑制リスト)に登録し、そのアドレスへのメール送信を抑制する。</p>
</section>
<section id="id9">
<h3><span class="section-number">16.2.5. </span>送信用DNS設定<a class="headerlink" href="#id9" title="この見出しへのパーマリンク">¶</a></h3>
<section id="id10">
<h4><span class="section-number">16.2.5.1. </span>メール送信の信頼性担保<a class="headerlink" href="#id10" title="この見出しへのパーマリンク">¶</a></h4>
<p>メール送信においてなりすましを防ぐための設定として、SPF・DKIM・DMARCといった技術が用いられる。</p>
<ul class="simple">
<li><p>SPF(Sender Policy Framework)</p></li>
<li><p>DKIM(Domain Keys Identified Mail)</p></li>
<li><p>DMARC(Domain-based Message Authentication Reporting and Conformance)</p></li>
</ul>
<p>メールでは、送信元を偽造することは比較的容易に可能。なりすましや改ざんにも対応する必要がある。
この問題に対して、ドメイン側で「自分のアドレスから送信して良いサーバーはこれだけです」と受信者に伝えたり、改ざん対策のための技術がSPF・DKIM・DMARC。</p>
<section id="spf">
<h5><span class="section-number">16.2.5.1.1. </span>送信の信頼性を高めるSPF<a class="headerlink" href="#spf" title="この見出しへのパーマリンク">¶</a></h5>
<p><code class="docutils literal notranslate"><span class="pre">エンベロープFROM</span></code>の送信元の偽造を防ぐための技術。</p>
<p>そもそもメールには、送信元の<code class="docutils literal notranslate"><span class="pre">ヘッダーFROM</span></code>とメールサーバーが付与する<code class="docutils literal notranslate"><span class="pre">エンベロープFROM</span></code>が設定されており、エンベロープFROMのメールアドレスのドメインを<code class="docutils literal notranslate"><span class="pre">メールFROMドメイン</span></code>と呼ぶ。
メールを送信する際には、メールサーバーが自分(メールサーバー)のIPとエンベロープFROMを設定する。</p>
<p>SPFでは、DNS側で、「このメールFROMドメインを送信して良いメールサーバーのIP」を公開しておく。
SPFにより、メールの<code class="docutils literal notranslate"><span class="pre">メールFROMドメイン</span></code>と<code class="docutils literal notranslate"><span class="pre">送信メールサーバーIP</span></code>が一致しているかを確認し、正しいメールサーバーからメールが送信されているかを検証できる。</p>
<p><img alt="" src="../_images/SES_SPF_1.png" />
<a class="reference external" href="https://qiita.com/K5K/items/dad9119d448d4d969fae">[SES入門] SPFを理解しよう！</a></p>
<p>注意点として、SPFではメールFROMドメインについての検証しかできないため、偽装されやすいヘッダーFROMの検証ができない。
これについては、後述するDMARCにより、ヘッダーFROMのドメインとメールFROMドメインの一致を検証する機能まで設定が必要。</p>
<p>SESを利用する場合、デフォルトでメールFROMドメインは、<code class="docutils literal notranslate"><span class="pre">amazonses.com</span></code>が設定される。
&quot;amazonses.com&quot;についてのSPFはAWS側で設定されているため、SPFについては自動で認証される。<br />
一方で、受信側でヘッダーFROMのドメインのSPFの認証を行う可能性もある。
そのため、以下のように送信で利用するメールアドレスについて、SPFを設定することは推奨。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Name（ホスト名）: example.com  
Type: TXT  
Value: &quot;v=spf1 include:amazonses.com -all&quot;
</pre></div>
</div>
<ul class="simple">
<li><p>&quot;include:amazonses.com&quot;：SESを許可</p></li>
<li><p>&quot;-all&quot;：SES以外を拒否</p></li>
</ul>
</section>
<section id="dkim">
<h5><span class="section-number">16.2.5.1.2. </span>送信の信頼性を高めるDKIM<a class="headerlink" href="#dkim" title="この見出しへのパーマリンク">¶</a></h5>
<p>電子証明を利用して、「メールは自分が送信した」ということを証明する
DKIMを設定することで、受信時にメールの信頼度が上がるため、スパム判定されにくくなる。</p>
<p>具体的には、送信時に秘密鍵で署名を付与し、DNSに設定された公開鍵を利用して署名を検証する。
公開鍵のアドレスをCNAMEとして３レコード設定する</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Name</span><span class="p">:</span> <span class="n">randomstring1</span><span class="o">.</span><span class="n">_domainkey</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>
<span class="n">Type</span><span class="p">:</span> <span class="n">CNAME</span>
<span class="n">Value</span><span class="p">:</span> <span class="n">randomstring1</span><span class="o">.</span><span class="n">dkim</span><span class="o">.</span><span class="n">amazonses</span><span class="o">.</span><span class="n">com</span>
</pre></div>
</div>
</section>
<section id="dmarc">
<h5><span class="section-number">16.2.5.1.3. </span>送信の信頼性を高めるDMARC<a class="headerlink" href="#dmarc" title="この見出しへのパーマリンク">¶</a></h5>
<p>特定のドメインからのメールに対して、「このように認証されているはず」「認証されてない場合はこのように扱って」ということが定義されている。</p>
<p>DMARCでは、SPFとDKIMについて認証が成功しているかと、ドメインの整合性のチェックを行う。
整合性チェックとは、FROMアドレスとエンベロープアドレスが一致しているかの検証が実施できる。<br />
SESで言えば前述の通り、メールFROMドメインがデフォルトでamazonses.comとなるため、DMARCでヘッダーFROMとエンベロープFROMが一致している整合性チェックを有効化するためにはカスタムメールドメイン機能（後述）が必要。※ただし、SESではカスタムメールドメインを利用してもSPFで厳密な整合性は利用できない。</p>
<p>DMARCの設定をTXTレコードとして公開する</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Name（ホスト名）: _dmarc.example.com  
Type: TXT  
Value: &quot;v=DMARC1; p=quarantine; rua=mailto:reports@example.com; adkim=r; aspf=r&quot;
</pre></div>
</div>
<ul class="simple">
<li><p>&quot;p=quarantine&quot;：DMARCポリシーの設定で、認証失敗したメールの扱いを定義できる</p></li>
</ul>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head text-left"><p>ポリシー</p></th>
<th class="head text-left"><p>内容</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-left"><p>p=none</p></td>
<td class="text-left"><p>失敗しても許可（まずは様子を見るモード）</p></td>
</tr>
<tr class="row-odd"><td class="text-left"><p>p=quarantine</p></td>
<td class="text-left"><p>失敗したら迷惑メールに入れるよう依頼</p></td>
</tr>
<tr class="row-even"><td class="text-left"><p>p=reject</p></td>
<td class="text-left"><p>失敗したら完全拒否するよう依頼</p></td>
</tr>
</tbody>
</table>
<ul class="simple">
<li><p>&quot;rua=mailto:reports&#64;example.com&quot;：DMARCポリシーで認証失敗した状況の定期レポートの送信先メールアドレス</p></li>
<li><p>&quot;adkim=r&quot;：DKIMの整合性チェックのレベルの設定</p></li>
</ul>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head text-left"><p>オプション値</p></th>
<th class="head text-left"><p>意味</p></th>
<th class="head text-left"><p>整合条件</p></th>
<th class="head text-left"><p>使われる場面</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-left"><p>r（relaxed）</p></td>
<td class="text-left"><p>緩やかな整合性</p></td>
<td class="text-left"><p>From: のドメインと DKIMの d= が同一またはサブドメイン</p></td>
<td class="text-left"><p>デフォルト。通常の運用に適している</p></td>
</tr>
<tr class="row-odd"><td class="text-left"><p>s（strict）</p></td>
<td class="text-left"><p>厳密な整合性</p></td>
<td class="text-left"><p>From: のドメインと DKIMの d= が完全一致</p></td>
<td class="text-left"><p>より強固なドメイン整合性を求める場合</p></td>
</tr>
</tbody>
</table>
<ul class="simple">
<li><p>&quot;aspf=r&quot;：SPFの整合性チェックのレベルの設定</p></li>
</ul>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head text-left"><p>オプション値</p></th>
<th class="head text-left"><p>意味</p></th>
<th class="head text-left"><p>整合条件</p></th>
<th class="head text-left"><p>使われる場面</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-left"><p>r（relaxed）</p></td>
<td class="text-left"><p>緩やかな整合性</p></td>
<td class="text-left"><p>From: のドメインと MAIL FROM のドメインが同一またはサブドメイン</p></td>
<td class="text-left"><p>デフォルト。MAIL FROMにサブドメイン（例: mail.example.com）を使う場合に有効</p></td>
</tr>
<tr class="row-odd"><td class="text-left"><p>s（strict）</p></td>
<td class="text-left"><p>厳密な整合性</p></td>
<td class="text-left"><p>From: と MAIL FROM のドメインが完全一致</p></td>
<td class="text-left"><p>strict alignment をDMARCで厳密に適用したいとき</p></td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="from">
<h4><span class="section-number">16.2.5.2. </span>カスタム メール FROM<a class="headerlink" href="#from" title="この見出しへのパーマリンク">¶</a></h4>
<p>SPFに基づくDMARC認証に合格するためには、<code class="docutils literal notranslate"><span class="pre">ヘッダーFROM</span></code>と<code class="docutils literal notranslate"><span class="pre">エンベロープFROM(メールFROMドメイン)</span></code>の一致が必要。
SESでは、デフォルトでエンベロープFROMが&quot;amazonses.com&quot;となるため、ヘッダーFROMの所有ドメイン&quot;example.com&quot;と一致しない。</p>
<p>そこで、SESから送信するメールのエンベロープFROMを変更する設定がカスタムメールFROM機能。
SESによって払い出されるドメイン<code class="docutils literal notranslate"><span class="pre">mail.example.com</span></code>についてのSPF用のTXTレコードと送信用のMXレコードを設定することで、エンベロープFROMのアドレスをmail.example.comに変更することができる。</p>
<p><img alt="" src="../_images/SES_custome_mail_from.png" />
<a class="reference external" href="https://pages.awscloud.com/rs/112-TZM-766/images/20190521_AWS-BlackBelt_AmazonSES.pdf">AWS Black Belt Online Seminar SES</a></p>
<p>送信メール時に利用するMXレコード設定</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Name</span><span class="p">:</span> <span class="n">mail</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>
<span class="n">Type</span><span class="p">:</span> <span class="n">MX</span>
<span class="n">Value</span><span class="p">:</span> <span class="mi">10</span> <span class="n">feedback</span><span class="o">-</span><span class="n">smtp</span><span class="o">.</span><span class="n">us</span><span class="o">-</span><span class="n">east</span><span class="o">-</span><span class="mf">1.</span><span class="n">amazonses</span><span class="o">.</span><span class="n">com</span>
</pre></div>
</div>
<p>SPF設定のためのTXTレコード設定</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Name</span><span class="p">:</span> <span class="n">mail</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>
<span class="n">Type</span><span class="p">:</span> <span class="n">TXT</span>
<span class="n">Value</span><span class="p">:</span> <span class="s2">&quot;v=spf1 include:amazonses.com -all&quot;</span>
</pre></div>
</div>
<p>注意点として、DMARCのSPFの検証については、strictを指定するとFROMアドレスとエンベロープアドレスについて完全一致を求められる。SESでカスタムメールFROM設定をしても、<code class="docutils literal notranslate"><span class="pre">example.com</span></code>と<code class="docutils literal notranslate"><span class="pre">mail.example.com</span></code>の比較になるので失敗してしまう。
DMARCではSPF検証を、relaxにしておく。これによりサブドメインレベルでの検証となるため、問題なく一致する。</p>
<p>カスタムメールFROMを<code class="docutils literal notranslate"><span class="pre">example.com</span></code>で設定すれば良いという考え方もあるが、カスタムメールFROMの設定には、MXレコードを設定する必要がある。
<code class="docutils literal notranslate"><span class="pre">example.com</span></code>のMXレコードは既に受信側で設定されており、競合してしまうためexample.comをカスタムメールFROMとして設定することはできないことが多い。</p>
</section>
</section>
</section>
<section id="id11">
<h2><span class="section-number">16.3. </span>送受信制約<a class="headerlink" href="#id11" title="この見出しへのパーマリンク">¶</a></h2>
<section id="id12">
<h3><span class="section-number">16.3.1. </span>メールサイズ<a class="headerlink" href="#id12" title="この見出しへのパーマリンク">¶</a></h3>
<p>SESの送受信では、メールの容量に制約があるため、要件に一致しているかを確認する。</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head text-left"><p>項目</p></th>
<th class="head text-left"><p>デフォルト制限</p></th>
<th class="head text-left"><p>申請後の最大制限</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-left"><p>送信メールの最大サイズ</p></td>
<td class="text-left"><p>10MB</p></td>
<td class="text-left"><p>40MB</p></td>
</tr>
<tr class="row-odd"><td class="text-left"><p>受信メールの最大サイズ</p></td>
<td class="text-left"><p>30MB</p></td>
<td class="text-left"><p>40MB</p></td>
</tr>
</tbody>
</table>
</section>
<section id="id13">
<h3><span class="section-number">16.3.2. </span>添付ファイル<a class="headerlink" href="#id13" title="この見出しへのパーマリンク">¶</a></h3>
<p>ファイルを添付する場合SESとして添付を拒否している拡張子がある。
<a class="reference external" href="https://docs.aws.amazon.com/ses/latest/dg/mime-types.html#:~:text=You%20can%20send%20messages%20with,extensions%20in%20the%20following%20list">Amazon SES unsupported attachment types</a>を確認して、条件を満たしているかを確認する。</p>
</section>
</section>
<section id="sesdns">
<h2><span class="section-number">16.4. </span>SESで設定するDNS設定のまとめ<a class="headerlink" href="#sesdns" title="この見出しへのパーマリンク">¶</a></h2>
<p>SESではいくつかのDNS設定が必要なため、上記で登場した設定をまとめる。</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head text-left"><p>設定目的</p></th>
<th class="head text-left"><p>レコード種別</p></th>
<th class="head text-left"><p>Name（ホスト名）</p></th>
<th class="head text-left"><p>Value（設定値）</p></th>
<th class="head text-left"><p>必須か？</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-left"><p>ドメイン所有権の証明</p></td>
<td class="text-left"><p>TXT (_amazonses)</p></td>
<td class="text-left"><p>_amazonses.example.com</p></td>
<td class="text-left"><p>SESが提供する検証コード</p></td>
<td class="text-left"><p>検証後削除OK</p></td>
</tr>
<tr class="row-odd"><td class="text-left"><p>受信メールの設定</p></td>
<td class="text-left"><p>MX</p></td>
<td class="text-left"><p>example.com</p></td>
<td class="text-left"><p>10 inbound-smtp.us-east-1.amazonaws.com</p></td>
<td class="text-left"><p>必須</p></td>
</tr>
<tr class="row-even"><td class="text-left"><p>送信元認証（SPF）</p></td>
<td class="text-left"><p>TXT</p></td>
<td class="text-left"><p>example.com</p></td>
<td class="text-left"><p>v=spf1 include:amazonses.com -all</p></td>
<td class="text-left"><p>推奨</p></td>
</tr>
<tr class="row-odd"><td class="text-left"><p>送信メールの改ざん防止（DKIM）</p></td>
<td class="text-left"><p>CNAME ×3</p></td>
<td class="text-left"><p>randomstring1._domainkey.example.com</br>randomstring2._domainkey.example.com</br>randomstring3._domainkey.example.com</p></td>
<td class="text-left"><p>SESが提供するDKIMキー</p></td>
<td class="text-left"><p>必須</p></td>
</tr>
<tr class="row-even"><td class="text-left"><p>送信ポリシー（DMARC）</p></td>
<td class="text-left"><p>TXT (_dmarc)</p></td>
<td class="text-left"><p>_dmarc.example.com</p></td>
<td class="text-left"><p>v=DMARC1; p=none; rua=mailto:reports&#64;example.com</p></td>
<td class="text-left"><p>推奨</p></td>
</tr>
<tr class="row-odd"><td class="text-left"><p>MAIL FROM用SPF</p></td>
<td class="text-left"><p>TXT (MAIF_FROM)</p></td>
<td class="text-left"><p>mail.example.com</p></td>
<td class="text-left"><p>v=spf1 include:amazonses.com -all</p></td>
<td class="text-left"><p>カスタム設定時</p></td>
</tr>
<tr class="row-even"><td class="text-left"><p>MAIL FROM用MX</p></td>
<td class="text-left"><p>MX（MAIL_FROM）</p></td>
<td class="text-left"><p>mail.example.com</p></td>
<td class="text-left"><p>10 feedback-smtp.us-east-1.amazonses.com</p></td>
<td class="text-left"><p>カスタム設定時</p></td>
</tr>
</tbody>
</table>
</section>
<section id="id14">
<h2><span class="section-number">16.5. </span>SESの送受信実装例<a class="headerlink" href="#id14" title="この見出しへのパーマリンク">¶</a></h2>
<p>SESを利用してメールの受信をしてS3に配置。メールの送信を行う場合の実装イメージをまとめる。</p>
<section id="id15">
<h3><span class="section-number">16.5.1. </span>ドメイン検証サンドボックスの解消<a class="headerlink" href="#id15" title="この見出しへのパーマリンク">¶</a></h3>
<p>利用するドメインについて、TXTレコードを利用した検証を行い登録をする。</p>
<p>AWSアカウントで、初めてSESを利用する場合はサンドボックス状態となっている。
サンドボックスでは、認証したメールアドレスにしか送信をすることができないため、一般的なメールサーバーとしての使用ができない。
そのため、最初に上限緩和申請をしてプロダクションにする必要がある。</p>
</section>
<section id="id16">
<h3><span class="section-number">16.5.2. </span>受信実装<a class="headerlink" href="#id16" title="この見出しへのパーマリンク">¶</a></h3>
<section id="receipt-rule">
<h4><span class="section-number">16.5.2.1. </span>受信ルール(Receipt Rule)の設定<a class="headerlink" href="#receipt-rule" title="この見出しへのパーマリンク">¶</a></h4>
<p>受信したメールに対してのアクションは<code class="docutils literal notranslate"><span class="pre">受信ルール(Receipt</span> <span class="pre">Rule)</span></code>で定義したものに従う。</p>
<p>受信ルールにより、受信したアドレスごとの制御<code class="docutils literal notranslate"><span class="pre">aaa&#64;example.com</span></code>と<code class="docutils literal notranslate"><span class="pre">bbb&#64;example.com</span></code>やS3に配置することやLambdaを呼び出して処理すると言ったアクションを定義することができる。</p>
<p>以下のCFnの例では<code class="docutils literal notranslate"><span class="pre">aaa&#64;example.com</span></code>に対しての受信メールはS3バケットの<code class="docutils literal notranslate"><span class="pre">aaa_emails</span></code>に配信する設定をしている。</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">EmailReceivingRuleSet</span><span class="p">:</span>
<span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::SES::ReceiptRuleSet</span>
<span class="w">    </span><span class="nt">Properties</span><span class="p">:</span>
<span class="w">        </span><span class="nt">RuleSetName</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;MyReceiptRuleSet&quot;</span>

<span class="nt">EmailReceivingRule</span><span class="p">:</span>
<span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::SES::ReceiptRule</span>
<span class="w">    </span><span class="nt">Properties</span><span class="p">:</span>
<span class="w">        </span><span class="nt">RuleSetName</span><span class="p">:</span><span class="w"> </span><span class="kt">!Ref</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">EmailReceivingRuleSet</span>
<span class="w">        </span><span class="nt">Rule</span><span class="p">:</span>
<span class="w">            </span><span class="nt">Name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;EmailToS3&quot;</span>
<span class="w">            </span><span class="nt">Enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">            </span><span class="nt">ScanEnabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">            </span><span class="nt">TlsPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Optional</span>
<span class="w">            </span><span class="nt">Recipients</span><span class="p">:</span>
<span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;aaa@example.com&quot;</span>
<span class="w">            </span><span class="nt">Actions</span><span class="p">:</span>
<span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">S3Action</span><span class="p">:</span>
<span class="w">                    </span><span class="nt">BucketName</span><span class="p">:</span><span class="w"> </span><span class="kt">!Ref</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">EmailS3Bucket</span>
<span class="w">                    </span><span class="nt">ObjectKeyPrefix</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;aaa_emails/&quot;</span>
</pre></div>
</div>
</section>
<section id="id17">
<h4><span class="section-number">16.5.2.2. </span>受信元の制限<a class="headerlink" href="#id17" title="この見出しへのパーマリンク">¶</a></h4>
<p>SESでは特定のIPだけに受信元を制限するフィルター機能が存在する。
送信元のメールアドレスによる制限機能は存在しないため、実装したい場合はLambda側で設定を行う必要がある。</p>
<p>特定のIPだけに受信元を制限する場合は、受信ルールの設定を追加で行う。</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">EmailReceivingRule</span><span class="p">:</span>
<span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::SES::ReceiptRule</span>
<span class="w">    </span><span class="nt">Properties</span><span class="p">:</span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">~~~~~</span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">Actions</span><span class="p p-Indicator">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">S3Action</span><span class="p">:</span>
<span class="w">                </span><span class="nt">BucketName</span><span class="p">:</span><span class="w"> </span><span class="kt">!Ref</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DefaultS3Bucket</span>
<span class="w">                </span><span class="nt">ObjectKeyPrefix</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;aaa-emails/&quot;</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">BounceAction</span><span class="p">:</span>
<span class="w">                </span><span class="nt">Message</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Unauthorized</span><span class="nv"> </span><span class="s">sender</span><span class="nv"> </span><span class="s">IP&quot;</span>
<span class="w">                </span><span class="nt">Sender</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ses@example.com&quot;</span>
<span class="w">                </span><span class="nt">SmtpReplyCode</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;550&quot;</span>
<span class="w">        </span><span class="nt">Condition</span><span class="p">:</span>
<span class="w">            </span><span class="nt">IpAddressFilter</span><span class="p">:</span>
<span class="w">                </span><span class="nt">Policy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Allow</span>
<span class="w">                </span><span class="nt">IpList</span><span class="p">:</span>
<span class="w">                    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;192.0.2.1/32&quot;</span>
</pre></div>
</div>
</section>
<section id="id18">
<h4><span class="section-number">16.5.2.3. </span>受信に関する権限設定<a class="headerlink" href="#id18" title="この見出しへのパーマリンク">¶</a></h4>
<p>SESについては、権限付与をするようなRole設定を行うことはできない。
そのため、SESの機能としてS3に配置を行う場合は、S3側のバケットポリシー側にSESからの操作の認可を与える必要がある。</p>
<p>さらに、SESからのアクセスを許可してしまうと、世界中のAWSからのアクセスが可能となってしまうので、制限を入れることを忘れない。</p>
<p>以下のバケットポリシー例では、principalとして<code class="docutils literal notranslate"><span class="pre">ses</span></code>を設定しているが、Conditon句でアカウントIDや受信ルールからのアクセスに限定している。SESの受信ルールがS3に操作をしようとしている関係になっている点に注意。</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="nt">EmailS3BucketPolicy</span><span class="p">:</span>
<span class="w">        </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::S3::BucketPolicy</span>
<span class="w">        </span><span class="nt">Properties</span><span class="p">:</span>
<span class="w">            </span><span class="nt">Bucket</span><span class="p">:</span><span class="w"> </span><span class="kt">!Ref</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">EmailS3Bucket</span>
<span class="w">            </span><span class="nt">PolicyDocument</span><span class="p">:</span>
<span class="w">                </span><span class="nt">Version</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;2012-10-17&quot;</span>
<span class="w">                </span><span class="nt">Statement</span><span class="p">:</span>
<span class="w">                    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Effect</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Allow</span>
<span class="w">                    </span><span class="nt">Principal</span><span class="p">:</span>
<span class="w">                        </span><span class="nt">Service</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ses.amazonaws.com</span>
<span class="w">                    </span><span class="nt">Action</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;s3:PutObject&quot;</span>
<span class="w">                    </span><span class="nt">Resource</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="s">&quot;arn:aws:s3:::${EmailS3Bucket}/*&quot;</span>
<span class="w">                    </span><span class="nt">Condition</span><span class="p">:</span>
<span class="w">                        </span><span class="nt">StringEquals</span><span class="p">:</span>
<span class="w">                            </span><span class="nt">aws:SourceAccount</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;123456789012&quot;</span>
<span class="w">                            </span><span class="nt">aws:SourceArn</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="s">&quot;arn:aws:ses:us-east-1:123456789012:receipt-rule/MyReceiptRule&quot;</span>
</pre></div>
</div>
</section>
</section>
<section id="id19">
<h3><span class="section-number">16.5.3. </span>送信実装<a class="headerlink" href="#id19" title="この見出しへのパーマリンク">¶</a></h3>
<section id="api">
<h4><span class="section-number">16.5.3.1. </span>送信APIの利用<a class="headerlink" href="#api" title="この見出しへのパーマリンク">¶</a></h4>
<p>送信については、いくつかの選択肢があるが、シンプルな構成でない限りは<code class="docutils literal notranslate"><span class="pre">SendRawEmail</span> <span class="pre">API</span></code>を利用する。
アプリケーション側でMIME規約に従ってメールを作成することで添付ファイルなども付与してメール送信が可能である。</p>
</section>
<section id="id20">
<h4><span class="section-number">16.5.3.2. </span>送信に関する権限設定<a class="headerlink" href="#id20" title="この見出しへのパーマリンク">¶</a></h4>
<p>SESを経由してメールを送信する場合、アプリケーション側にSESに対する権限を付与する必要がある。
SendRawEmailの権限を付与すれば良い</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="w">        </span><span class="nt">Policies</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">PolicyName</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;SendEmailPolicy&quot;</span>
<span class="w">            </span><span class="nt">PolicyDocument</span><span class="p">:</span>
<span class="w">                </span><span class="nt">Version</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;2012-10-17&quot;</span>
<span class="w">                </span><span class="nt">Statement</span><span class="p">:</span>
<span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Effect</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Allow</span>
<span class="w">                    </span><span class="l l-Scalar l-Scalar-Plain">Action</span><span class="p p-Indicator">:</span>
<span class="w">                        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;ses:SendEmail&quot;</span>
<span class="w">                        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;ses:SendRawEmail&quot;</span>
<span class="w">                  </span><span class="w w-Error">  </span><span class="nt">Resource</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;*&quot;</span>
</pre></div>
</div>
<p>なお、リソースの部分には、SESで検証したドメインのうち利用できるものを指定する。
<code class="docutils literal notranslate"><span class="pre">arn:aws:ses:us-east-1:123456789012:identity/example.com</span></code></p>
<p>上記の設定をしておくと、メールのFromとして<code class="docutils literal notranslate"><span class="pre">&#64;example.com</span></code>を利用することができる。</p>
</section>
<section id="sns">
<h4><span class="section-number">16.5.3.3. </span>バウンス設定(SNS配信)<a class="headerlink" href="#sns" title="この見出しへのパーマリンク">¶</a></h4>
<p>SESがメールを送信した際に、メールアドレスの不存在などでメールが送れないメールをバウンスメールと呼ぶ。</p>
<p>SESのNortificaion設定でバウンスメールが発生した場合のアクションを指定することができる。
そのため、バウンスメール設定でSNSのメールアドレスを指定しておくことで、メールの配信に失敗するとSNSに配信することができる。</p>
</section>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="AutoScaling.html" class="btn btn-neutral float-left" title="15. AutoScaling" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../GCP/GCP.html" class="btn btn-neutral float-right" title="1. GCPについて" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, author.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>