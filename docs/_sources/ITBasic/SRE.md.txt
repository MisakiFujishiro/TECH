# SRE
SREには3つの原則
- いついかなるシステムにおいて最も重要な機能は、信頼性である
- 監視が信頼性を決めるのではない。ユーザー（のExperience）が決めるの
- 巧妙に設計されたソフトウェアは99.9%/巧妙に設計された運用は99.99%/巧妙に設計されたビジネスは99.999%

[メモ]30日分のエラー予算
- 99.9%=43分
- 99.99%=4.3分
- 99.999%=26秒

開発者のAgilityと運用者の安定性についてバランスをとるべく、サービスの望ましい信頼性について議論を行うベースを定義する。
結果としてSREは、DevPosをツールとして、組織に組み込み活用することで信頼性を担保する。

`SREの最大の目標は、信頼性の制約下において、開発速度を最大化すること`

## 信頼性の定義
信頼性とは、ユーザーが達成したい目標を達成できているか。（Netflixで映画を観れるか、Google Searchで検索できるか）
すなわち、ユーザーに提供する価値を問題なく提供できているかがポイントになり、その一連のユーザーとサービスのやり取りを`ユーザージャーニー`と定義する。

ユーザージャーニー＝ユーザーは目標達成のためにサービスとやり取り

## 信頼性の測定
### SLI(Service Level Indicator: サービスレベル指標)
サービスの信頼性（ユーザーに提供する価値）を可視化する指標を定義する必要がある

良い指標は、信頼性が高い状態と低い状態を明確に検知することができる指標である。
```
      良いイベント
SLI＝-------------
      有効なイベント
```

また、管理上ユーザージャーニーあたりSLIは1-5にするべき

#### SLIをどう定めるか
以下SLIを設定するコツ
- フォーマットの利用
    - SLIは、提供するサービスの種別によって、利用するべきSLIのテンプレートなどが提供されているので利用する。
    - 例えば、Webサービスのようにリクエストレスポンスが必要なサービスであれば可用性やレイテンシーなど。
- 値をまとめる
    - 各サービスごとにレイテンシーを定めるのでなく基本は一律にして必要に応じて例外を設定する
    - インタラクティブは100ms/書き込みは1sec/バックグラウンドは3secなど
- ユーザー価値でまとめる
    - 最終的にユーザーに提供している価値でまとめる。
    - 例えば、Webサービスであれば「閲覧」をしているのだから、閲覧ができているという点をSLIにする。

### SLO(Service Level Objective: サービスレベル目標)
提供者が内部で設定する目標値で、SLA達成のための内部的な目安。
（ユーザーの満足と不満足の境界線）

100%を設定することは誤りであり、達成可能な目標を設定する。
サービスには、かろうじて達成されれば大抵のお客様が満足するような性能や可用性レベルをSLOとするとよい。

エラーバジェットにつながるが、SLOが設定されているからこそ、新規開発（Agile）と安定運用どちらを優先するかを数値ベースで議論することができる。


SLOの選択には「何を測るか」と「どう評価するか」の組み合わせが重要
- 何を測るか
    - レイテンシメトリック
    - 可用性メトリック
- どう評価するか
    - リクエストベースの評価方法
    -vウィンドウベースの評価方法

上記の組み合わせでSLOを定める。具体例としては以下。

|リクエストベース評価|ウィンドウベース評価| |
|:----|:----|:----|
|レイテンシメトリック|300ms 未満で返ったリクエストが 全体の 90% 以上|5 分間の 平均レイテンシが 300ms 未満|
|可用性メトリック|成功（HTTP 2xx/3xx）したリクエストが 99.9% 以上|5 分間の 成功率が 99.9% 以上|


### SLA(Service Level Agreement: サービス品質保証契約)
提供者と利用者間の正式な契約で、サービスレベルの最低保証水準。

顧客が受け入れることができる最低限の設定値。

### エラーバジェット(信頼性を高める時)
SLOは、裏返せばエラーの許容レベルとも言える。（99.9%の可用性=0.01%の非可用性）。
このエラー許容度をエラーバジェットと呼び、予算のように分配可能と考える。

エラーバジェットを見ながら機能開発と改善のバランスを定める。

エラーバジェットは、コミュニケーションツールであり、バランスを定めるための指標。
エラーバジェットを使い切ってしまったら、リリースを止め品質改善に努めるべきなどあらかじめポリシーを決定しておく。

### 信頼性の改善
信頼性を改善するための軸として以下の指標が挙げられる
- 影響（ユーザー・リクエスト・インフラへの影響）
- MTTD(Mean Time To Detection): 問題発生からの検知時間（監視性能）
- MTTR(Mean Time To Repaire): 問題発生から修復までの時間（保守性）
- MTBF(Mean Time Between Failures): 稼働してから問題発生までの間隔（信頼性）

## 心理的安全性
心理的安全とは、アイデアや質問、懸念や間違いについて話をすることで罰せられたり恥をかいたりすることがないという信念。

心理的安全性を作るために意識すること
- 人を責めない。学習の機会ととらえる
- 自分自身が誤りやすいことを認める
- 好奇心を示して、多くの質問をする 

心理的安全性のあるチームは誰がいるか関係なく、価値を提供することができるチームであった。
システム開発においても、リードタイムの短縮やリリース頻度、復旧時間などに良い影響がある。

### ポストモーテム（事後検証）
インシデントを学びの機会として捉え、改善していくためにインシデントを記録するものがポストモーテム

ポストモーテムでは以下を記載する
- 暫定対応：インシデントの緩和または解決のために取られるアクション
- 影響：インシデントのインパクト
- 根本原因：原因分析結果
- 再発防止：フォローアップアクション

## トイル
トイルとは、手作業で繰り返され、自動化は可能だが、長期的価値を生まず、サービスの成長と共に増え続ける運用作業
- 手作業
- 反復
- 自動化可能
- 戦術的（戦略的でない）
- 継続価値がない
- 線形に増加

トイルは全てをなくすことはできないし、トイル自体に価値がある場合や、トイルを通じてシステムの理解をすることができる。
基本的なスタンスは、トイルを特定し、自動化してできるだけ減らす。
理想的な割合は、`プロジェクト作業:トイル・オーバーヘッド＝5:5`

SREの根本的な考え方として、エンジニアの健康を大切にするというものがある。

### 割り込み対処
割り込みが最も一般的なトイルであり、集中力が妨げられる。
割り込み作業もチームとして対応する必要がある。

基本的な対応方針はシストを組むこと
- トイル担当の人はトイルを行い、プロジェクト作業は行わない
- プロジェクト作業の人は、トイルの対応を行わない

### オンコールシフト
オンコールの呼び出しも割り込みとなる。

オンコールはエンジニアにとっても大きなストレスとなるため、以下を意識する
- シフト時間を小さくする
- 引き継がれるタイミングをスケジュールする
- インシデント時には引き継ぎをする
- そもそものレスポンスタイムやSLOの定義に気を使う
- オンコーラーが大切にされているという実感が大切

## インシデント対応
どんなものも壊れてしまう。その考えを前提に、パニックにならずにインシデント対応することが大切。
根本原因を見出す。原因は`変化によって発生する`ので直近の変化や変化の起因をトレースする

`今後直面すること以上に悲惨な問題を人々はこれまで解決してくれている。`その知見を体系化した仕組みがあり、その一つがICS(Incident Command System)


### ICS(Incident Command System)
インシデント対応の問題になるは、コミュニケーション・作業管掌区分であり、この課題を解決するべく開発されたシステムがICS。

ICSにおける代表的な役割は以下  
以下のように選任を定めることで、コミュニケーションロスを避け、対応の集中を促す。
また、ディスカッションと調査が行われている場所（スレッドなど）を明確認する。

|CS Role|日本語訳・呼び方（例）|主な責務|IT / SRE インシデントでの具体例|
|:----|:----|:----|:----|
|Incident Commander (IC)|インシデントコマンダー / 司令官|インシデント全体の統括責任者。意思決定・優先順位付け・役割分担を行う|影響範囲の判断<br>復旧優先度の決定<br>「今は復旧最優先」「原因調査は後」と判断|
|Operations Lead（OL）|対応リード / 実行責任者|実作業の指揮。復旧作業を直接進める|サービス再起動<br>ロールバック実施<br>スケール調整|
|Communications Lead（CL）|コミュニケーション担当|情報共有・対外連絡の統制|Slack/Teams での定期状況報告<br>ステークホルダーへの進捗共有|
|Planning Lead|計画・状況整理担当|状況把握・次の一手の計画|タイムライン整理<br>仮説整理<br>次に試す対応案の提示|
|Technical Lead / Subject Matter Expert (SME)|技術リード / 専門家|技術的判断・設計レビュー|DB/Network/GKE/Cloud Run の技術判断<br>「この変更は安全か？」のレビュー|
|Scribe / Recorder|記録係|事実の記録|時系列ログ作成<br>ポストモーテム用メモ|



## Observability
Observabilityとは、外から見えるデータを利用してシステムの内部状態を理解できる能力。
以下のMetrics/Traces/Logs/(Profiling)の要素を組み合わせて、Observabilityを担保する。

|要素|役割|フェーズ|
|:----|:----|:----|
|Metrics|状態の定量把握|予防・健全性監視|
|Traces|リクエストの経路把握|影響範囲特定|
|Logs|事実・イベントの記録|根本原因分析|
|Profiling|内部実装のボトルネック分析|最適化|
