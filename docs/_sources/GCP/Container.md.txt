# コンテナサービス
## Kubernetes
Kubernetesとは、コンテナを複数のホストにまたがって管理するオープンソースのコンテナオーケストレーションサービス。 Eオーケストレーションの機能を有しているが、オープンソースであるという特徴からさまざまなエコシステムとの連携を行うことができる。

### Kubernetesの構成要素
Kubernetesの構成は、大きく次の2つのレイヤに分かれる。
- コントロールプレーン：クラスタ全体を管理する「頭脳」
- ノード（ワーカー）：実際にアプリ（コンテナ）を動かす「手足」

|レイヤ|コンポーネント|役割・説明|
|:----|:----|:----|
|コントロールプレーン|kube-apiserver|外部や内部からのリクエストを受け付けるAPIサーバ|
||etcd|クラスタ全体の状態を保存するキーバリューストア|
||kube-scheduler|Podをどのノードに配置するか決定する|
||kube-controller-manager|実際の状態が理想状態になるように調整|
|ノード（ワーカー）|kubelet|ノード上でPodを管理・監視するエージェント|
||kube-proxy|ノード内のネットワークルールを管理|
||Container Runtime|コンテナを実行するエンジン（例：containerd、Docker）|

Kubernetesを理解するうえで押さえておきたい中核的な構成要素は次の通り。

|要素|意味・説明|
|:----|:----|
|Cluster|Kubernetes全体の実行環境。ノードの集まり|
|Node|Podを実行するサーバー（VMや物理マシン）|
|Pod|Kubernetesにおける最小の実行単位。1つ以上のコンテナを含む|

より現実的なアプリ運用で頻出するKubernetesリソースは以下の通り。
Kubernetesの特徴的な考え方は、処理を依頼する実行型ではなくて、あるべき姿を記載した宣言型の動きをするところ。
あるべき姿を記述したドキュメントを準備することで、Kubernetesはマネージドにその姿を目指してオーケストレーションしてくれる。

|用語|意味・説明|
|:----|:----|
|YAMLマニフェスト|Kubernetesにリソースを宣言するための設定ファイル形式|
|Deployment|Podの数や更新戦略などを定義するオブジェクト|
|ReplicaSet|同じPodを複数実行して可用性を確保するための仕組み|
|Service|Podに安定した名前でアクセスできるようにする抽象化レイヤ|
|Namespace|リソースをグループ化するための仮想的な区切り|
|ConfigMap / Secret|設定情報や機密情報を外部化してPodに注入できるオブジェクト|
|Horizontal Pod Autoscaler|負荷に応じてPodの数を自動調整する仕組み|

### Kubernetesの課題
Kubernetesは、分散システムであり、コントロールプレーン・データプレーンでさまざまなコンポーネントが動作しており、運用管理が煩雑になりがちである。


## GKE(Google Kubernetes Engine)
KubernetesをGCP上で簡単に利用できるようにしたマネージドサービス。
GKEをりよす売ることでKubernetesのセットアップをすべてマネージドにしてくれる。

GKEを利用することで以下のようなことが可能となる。

|機能|説明|
|:----|:----|
|クラスタ作成・管理の自動化|数クリック or CLI でクラスタが作れる|
|ノードのアップグレード・修復|OSのパッチ適用、ダウン時の自動回復|
|スケーリング|ノード数やPod数の自動増減（オートスケーリング）|
|セキュリティ統合|IAMやVPCと統合。ネットワークやアクセス制御もGoogle Cloud流に設定可能|
|モニタリング・ログ|Cloud Monitoring / Loggingと統合。可視化がラク|

さらに、クラスター構成について言えば、コントロールプレーンについてはすべてGKE側で制御されるため、ユーザーはノード側に集中することができる。

|レイヤ|管理主体|役割・説明|
|:----|:----|:----|
|コントロールプレーン|Google Cloudが管理|Kubernetesの中枢（APIサーバ、スケジューラなど）。利用者は気にしなくてよい|
|ノードプール（Node Pool）|ユーザーが管理（ある程度）|実際にコンテナを動かすVM群。GCE（Compute Engine）インスタンスとして提供される|
|Pod|Kubernetesが自動管理|ユーザーのアプリケーション本体が動く|
