# DB
GCPで提供される代表的なデータサービスにはRDS系（CloudSQL/AlloyDB/Spanner）とNoSQL系（Firestore/Bigtable）の大きく二つがある。

簡単なまとめは以下の通り。

|サービス|データモデル (タイプ)|
|:----|:----|
|Cloud SQL|リレーショナル (SQL)※MySQL/PostgreSQL/SQL Server|
|AlloyDB|リレーショナル (PostgreSQL互換)|
|Cloud Spanner|リレーショナル (分散SQL)|
|Cloud Firestore|ドキュメント NoSQL|
|Cloud Bigtable|ワイドカラム NoSQL|


## Cloud SQL
フルマネージドなRDSサービス。
MySQL・PostgreSQL・SQL Serverをサポートし、マシンタイプを選択することでスペックを指定する。
小〜中規模のウェブアプリケーションや社内業務システムなど、1つのリージョン内で完結する典型的なトランザクション処理に適している。

Cloud SQLは単一リージョン内の高可用構成（マルチゾーン構成）をサポートし、自動フェイルオーバーによって99.95%の月間稼働率SLOを提供。
必要に応じてリードレプリカを追加して読み取りスケールを拡大したり、データベースを複数リージョンに配置して耐障害性を高めることも可能。
一方で書き込みは単一のプライマリインスタンスに集約されるためスケールアップ（垂直スケーリング）が中心で、Cloud Spannerのような水平分散はできない。

## AlloyDB
2022年に登場したPostgreSQLの100%互換であり、エンタープライズ向けに性能・可用性を強化したフルマネージドサービス。要求の厳しいOLTP（オンライントランザクション処理）だけでなく、リアルタイム分析クエリにも高い性能を発揮するよう設計されている。ストレージとコンピュートの分離や独自のカラム型エンジン、機械学習による自動最適化などにより既存PostgreSQLを大きく強化しており、分析クエリ性能は標準PostgreSQLの最大100倍、トランザクション処理性能も4倍以上と発表されている。

AlloyDBはマルチゾーン高可用構成によってメンテナンス中も含めて99.99%のSLA稼働率を提供し、障害発生時も60秒以内に自動復旧する設計。読み取りプールと呼ばれる複数の読み取りノードを追加することで読み取り負荷を水平スケールアウトでき、ストレージも自動で最大32TiBまで拡張。
一方、書き込み処理は単一プライマリノードで行うため、書き込み性能向上にはインスタンスサイズ拡大（スケールアップ）で対応します

AlloyDBにはクラスター・インスタンス・ノードという概念が存在する。

|構成要素|役割・機能|
|:----|:----|
|クラスタ|AlloyDBリソースをまとめる最上位の論理コンテナ。<br>特定リージョン内のデータベースやログなど全リソースを1つのクラスタに編成します。<br>データはクラスタ共通の分散ストレージ層に保存され、高可用性や耐久性を実現します。|
|プライマリ インスタンス|クラスタ内に1つだけ存在するメインのDBインスタンス。<br>読み書き両方のアクセスポイントを提供します。<br>トランザクションの処理を担い、クラスタの書き込み要求を一手に引き受ける役割です（必要に応じて読み取りも可能）。|
|読み取りプール インスタンス|追加の読み取り専用インスタンス。<br>主に読取りクエリのスケーリング（水平分散）のために使用します。<br>レポートや分析系のクエリなど、プライマリに負荷をかけたくない読み取り処理をオフロードする役割です。|
|ノード|PostgreSQLエンジンが動作する仮想マシンです。<br>クエリ実行やキャッシュ処理など実際のデータベース処理を担う最小の計算ユニットになります。<br>AlloyDBではノード上でデータを書き込み/読み取りしつつ、ストレージは分離されているため高速な障害復旧やスケーラビリティを実現します。|


## Spanner
Cloud Spanner は Googleが自社のインフラ技術を基に提供するグローバル分散リレーショナルデータベースです。他のRDBとは異なり、複数のリージョン/ゾーンにまたがる分散配置によって卓越した可用性とスケーラビリティを実現。Googleの分散合意アルゴリズム分散環境でも強い整合性を保ったACIDトランザクションを保証している。

グローバル展開するミッションクリティカルなサービスや、極めて大規模なトランザクション処理が求められるシステムに適している。例えば、世界中のユーザーが同時利用するような決済プラットフォームや在庫管理システム、金融取引システムなど、一瞬の停止やデータ不整合も許されない領域で威力を発揮。Cloud SQLが単一リージョン前提の従来型RDBであるのに対し、Spannerは地理的に分散した単一データベースを提供するため、リージョン障害を含むあらゆる障害からの自動復旧とグローバル一貫性を両立したい場合に選択される。

Cloud Spanner最大の特徴は可用性とスケール。マルチリージョン構成では業界最高水準の99.999%の高可用性SLAを実現しており、計画停止やリージョン障害時でもダウンタイム無しで稼働し続け、単一リージョン構成でもマルチゾーン同期レプリケーションにより99.99%の可用性を確保。
スケーラビリティ面では、ノードを追加するだけで読み取り・書き込み両方を水平スケールアウト可能で、データ量やトラフィックの増大に応じてほぼ無制限に性能を向上でき、データはリレーショナルスキーマで厳密に構造化され、強整合性の下でグローバルトランザクションが可能です。


## Firestore
Cloud Firestore は GCPが提供するフルマネージドのNoSQLドキュメントデータベースで、Firebaseプラットフォームの一部としてモバイル・ウェブアプリ向けに最適化されている。データはJSON形式のドキュメントとして保存される。

ユーザー端末間のリアルタイムなデータ共有が必要なアプリケーションに最適。例えばチャットやコラボレーションアプリのメッセージ/ドキュメント同期、ゲームアプリのプレイヤーデータ保存、IoTデバイスからのイベントログの蓄積（小〜中規模なデータ量）などに利用。

具体的なメリットを挙げると以下
- Firestoreはクラウド側にデータを持ち、SDKでデータの取得・更新を行うので端末間の動機が行われる
- オフラインサポートをしており、アプリ利用中のデータをキャッシュし、オンライン復帰後にSDKが同期してくれる
- リアルタイム更新が可能


## Bidtable
Cloud Bigtable は 大規模データ処理とリアルタイム分析に特化したNoSQLデータベース。キー・バリュー/ワイドカラム型のデータモデルを採用しています。単一のテーブルで数十億行×数千列規模にスケール可能で、ペタバイト級のデータを扱うことができる。

Bigtableは分散設計により非常に低いレイテンシでのデータアクセスを実現しており、適切に構成すれば1桁ミリ秒以下の応答で大量リクエストを処理できる。ノードの追加によって水平スケーリングが可能で、負荷に応じて透過的にスループットを伸ばせま、マルチクラスター（複数リージョン）構成をとれば障害耐性も高まり、サービス稼働率99.999%といった高可用性を達成できる。ただしマルチクラスター環境下では最終的整合性モデルとなり、あるクラスターでの更新が他に伝搬するまで遅延が生じる点に注意が必要。

### AppProfile
Bigtable は、1 つのインスタンスを複数のアプリケーションから利用できる設計になっている。
そのため、
- リアルタイム API（高可用性重視）
- バッチ処理（特定リージョン固定）
- 管理ツール（コスト重視）

といった 異なる要件を持つアプリケーションごとに、接続ポリシーを切り替える必要がある。

この「使い方の違い」を表現するために、可用性やルーティングの選択は Bigtable 全体ではなく`App Profile`としてアプリケーション単位で定義される。

App Profile は、アプリケーションが Bigtable のどのクラスターに、どのようなルーティングでアクセスするかを定義する設定である。

App Profile では、主に以下の 2 つのルーティング方式を選択できる。

- Single-Cluster Routing
    - 特定のクラスターに固定してアクセス
    - レイテンシが安定しやすい
    - クラスター障害時は 手動フェイルオーバーが必要
- Multi-Cluster Routing
    - 複数クラスターに対して自動ルーティング
    - 障害時は健全なクラスターへ自動的に切り替え
    - レイテンシの低いクラスターを優先可能
    - 高可用性・運用負荷低減に適する