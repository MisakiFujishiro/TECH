# GCE(Google Compute Engine)
## Compute Engine
仮想マシンインスタンスを提供するIaaSのサービス。
LinuxやWindowsなどのOSに対応し、CPU/メモリ/ストレージを自由に構成することができる。
また、GCPのグローバルなネットワークインフラ上で起動させることで、高可用性設計が可能。

### インスタンスのタイプ
インスタンスを作成する際には、利用目的に応じてマシンシリーズやマシンタイプを指定する。それぞれの用語の特徴は以下。

|EC2用語|概要|GCE用語（新体系）|例|
|:----|:----|:----|:----|
|インスタンスファミリー|VMの用途・性能バランスごとの大分類|マシンファミリー（H）|H（Hyperdisk対応）|
|世代/シリーズ|同じファミリー内で世代や構成の違いを表す|マシンシリーズ（H3）|H3（第3世代）|
|インスタンスタイプ|vCPUとメモリ量で個別に識別される構成名|マシンタイプ（standard-88）|h3-standard-88|


### ストレージオプション
VMを作成する際OSなどが入っているブートディスクはデフォルトで作成される。
ブートディスクは別に外部ディスクをマウントすることができ、これを`ストレージオプション`と呼ぶ。

大きく3つのストレージオプションが準備されている。
また、それぞれについてもバランスタイプやエクストリームタイプなど種別が存在。

|種類|特徴|向いている用途|
|:----|:----|:----|
|Persistent Disk|標準的な高可用ディスク|汎用データ保存（アプリ、ログ、DB等）|
|Hyperdisk|高スループット・IOPS可変|データベース、分析ワークロード|
|Local SSD|超高速・揮発性（VM停止で消える）|キャッシュ、テンポラリ処理|

### バックアップ
インスタンス（VMおよび外部ストレージ）のバックアップについては`スナップショット`、`カスタムイメージ`、`マシンイメージ`の3種類の方法がある。

|バックアップ方式|復元されるもの|復元されないもの（手動対応）|想定ユースケース|
|:----|:----|:----|:----|
|スナップショット|永続ディスクの中身（OS含む可能性あり）|VM本体（マシンタイプ、ネットワーク設定、タグ、メタデータ等）⇒ VMの再作成・設定が必要|データ保護や一部ディスクのバックアップ|
|カスタムイメージ|ブートディスクの中身（OS・アプリ・初期設定済）|VM構成（CPU数・メモリ・ネットワーク設定・タグ）⇒ 新しいVM作成時に再指定が必要|テンプレートVMの複製、OS構成の展開|
|マシンイメージ|VMのすべて（ディスク＋構成情報＋メタデータ）⇒ ほぼワンクリックで完全復旧可|基本的になし（ただし最新情報とのギャップには注意）|本番環境のDR用途、完全なバックアップ、環境の複製|




### 費用
費用に関しては重要課金制である。1分以降は秒単位での課金が発生する。
費用の割引としては以下を意識しておくと良い。
- 継続利用割引・・・1ヶ月で25%以上利用すると自動で割引される
- 確約利用割引・・・1年/3年で利用を確約することで割引を受けることができる

### Compute Engineの高可用性
GCEでは障害発生時の対応として大きく2種類の対応が存在。
`ライブマイグレーション`はユーザー側として意識することはないが、`ホストエラー`については、ハードウェア障害としてアプリに影響するため高可用性を担保するためには単一障害点とならない構成にする必要がある。

|項目|ライブマイグレーション|ホストエラー|
|:----|:----|:----|
|内容|物理ホストのメンテナンス前にVMを事前に別ホストへ移動|物理ホストが突然ダウンしてVMが強制停止|
|トリガー|Googleによる予防的なメンテナンス|ハードウェア障害などによる予期せぬ停止|
|VMの状態|停止せずに稼働し続ける（ほぼ無停止）|一時的に停止またはクラッシュ（再起動が必要）|
|GCPの対応|自動で別ホストにVMを移行|自動的に再起動される（オプション設定による）|

